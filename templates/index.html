{% extends "base.html" %}

{% block content %}
    <!-- Your original HTML content goes here, but remove the style section -->
    <!-- I've removed the CSS for brevity - it will be in style.css -->
    
    <div class="sensor-data">
        <!-- ... sensor data HTML ... -->
        <div class="sensor-item">
            <div class="sensor-value" id="ds-temp1">X °C</div>
            <div class="sensor-value" id="ds-temp2">X °C</div>
            <div class="sensor-value" id="ds-temp3">X °C</div>
            <div class="sensor-label">Temperature</div>
        </div>
        <div class="sensor-item">
            <div class="sensor-value" id="dht-humidity">X %</div> 
            <div class="sensor-label">Humidity</div>
        </div>
        <div class="sensor-item">
            <div class="sensor-value" id="co2-ppm">X ppm</div>
            <div class="sensor-label">CO2 Level</div>
        </div>
        <div class="sensor-item">
            <div class="sensor-value">X Days X Hours</div>
            <div class="sensor-label">Growth Time</div>
        </div>         
    </div>
    
    <div class="dashboard">
        <!-- ... dashboard HTML ... -->

        <div class="card">
            <h2>Camera Controls</h2>
            <!--<button onclick="fetchClip()">Record Growth Clip</button>-->
            
            <!-- Interval input box -->
            <div class="parameter-item">
                <span class="parameter-label">Timelapse Interval</span>
                <input type="text" class="parameter-input" id="timelapse-interval" value="">
            </div>

            <button onclick="toggleTimelapse()" id="toggle-btn">Toggle Timelapse</button>
            <button onclick="fetch('/restart_tl')">Restart Timelapse</button>
            <div class="status" id="tl-status">Number of timelapse photos ...</div>
        </div>
             
            
        <div class="card">
            <h2>Environment</h2>

            <div class="parameter-item">
                <span class="parameter-label">Set Temperature (°C)</span>
                <input type="text" class="parameter-input" id="temperature-setpoint" value="">
            </div>

            <div class="parameter-item">
                <span class="parameter-label">Set Humidity (RH)</span>
                <input type="text" class="parameter-input" id="humidity-setpoint" value="">
            </div>

            <div class="parameter-item">
                <span class="parameter-label">Set CO2 (ppm)</span>
                <input type="text" class="parameter-input" id="co2-setpoint" value="">
            </div>

            <button onclick="fetch('/set_light_schedule')">Light Schedule</button>
            <button onclick="fetch('/set_light_wavelength')">Light Wavelengths</button>
            <div class="status" id="env-status">Stable</div>
        </div>
        
        <!--
        <div class="card">
            <h2>Lighting</h2>
            <button onclick="fetch('/toggle_light')">Toggle Grow Lights</button>
            <button onclick="fetch('/set_light_schedule')">Set Light Schedule</button>
            <div class="status" id="light-status">Off</div>
        </div>
        -->
        
        <div class="card">
            <h2>System</h2>
            <button class="warning" onclick="fetch('/emergency_stop')">Emergency Stop</button>
            <button onclick="fetch('/update_settings')">Update Settings</button>
            <button onclick="fetch('/view_logs')">View System Logs</button>
        </div>
        
        <div class="card">
            <h2>Google Drive</h2>
            <button onclick="fetch('/upload_tl')">Upload Time Lapse</button>
            <button onclick="fetch('/upload_logs_drive')">Upload Logs</button>
        </div>

        <button class="save-btn" id="save-button" disabled>Save Changes</button>

        <div class="status-message" id="unsaved-message">You have unsaved changes</div>
        <div class="status-message status-saved" id="saved-message">Changes saved successfully!</div>
        

        {% if not current_user.is_admin %}
        <div class="card">
            <h2>Notice</h2>
            <p>You are viewing in read-only mode. Admin access required for controls.</p>
        </div>
        {% endif %}
    </div>

    <div class="webcam-container">
        <h2>Latest Webcam Image</h2>
        <img id="webcam" src="/send_latest_image" class="latest-img"/>
        <button onclick="refreshManual()">Take New Photo</button>
        <div class="status" id="photo-status"></div>
    </div>
    
    <!-- ... the rest of your HTML ... -->
    
    <script>

        //Globals
        let CO2Data = null;
        let tempData = null;
        let humidData = null;

        let tlData = null;
        let controlData = null;

        // Your JavaScript code 
        // Control paramters

        // const externalConfig = {
        //     "timelapseInterval": 30,
        //     "temperatureSetpoint": 22.5
        // };
        
        // Track original values and changed status
        const originalValues = {};
        const changedInputs = new Set();

        async function get_env_parameters() {
            try {
                // Fetch CO2 sensor data
                let res = await fetch('/co2_sensor');
                CO2Data = await res.json();

                // Fetch temperature sensor data
                res = await fetch('/DS18B20_sensor');
                tempData = await res.json();

                // Fetch humidity sensor data
                // debugger;
                res = await fetch('/DHT22_sensor');
                // debugger;
                humidData = await res.json();
                // debugger;
                

                
                console.log("Environment parameters updated:");
                updateUIWithSensorData();
                
            } catch (err) {
                console.error("Error fetching data:", err);
            }
        }

        async function get_control_parameters() {
            try {
                // Fetch timelapse status
                let res = await fetch('/timelapse_status');
                tlData = await res.json();

                res = await fetch('/control_status');
                controlData = await res.json();
                
                console.log("Control parameters updated:");

                updateUIWithControlData();

                initializeOriginalValues();
                
            } catch (err) {
                console.error("Error fetching data:", err);
            }
        }

        function initializeOriginalValues() {
            originalValues['timelapse-interval'] = tlData?.interval ?? null;

            originalValues['temperature-setpoint'] = controlData?.setpoints?.temperature ?? null;
            originalValues['humidity-setpoint']    = controlData?.setpoints?.humidity ?? null;
            originalValues['co2-setpoint']         = controlData?.setpoints?.co2_max ?? null;
            originalValues['light-schedule']       = controlData?.setpoints?.light_schedule ?? null;

        }   

        function updateUIWithControlData(){
            if (tlData && controlData){
                document.getElementById("timelapse-interval").value = tlData.interval;
                document.getElementById("temperature-setpoint").value = controlData.setpoints.temperature;
                document.getElementById("humidity-setpoint").value = controlData.setpoints.humidity;
                document.getElementById("co2-setpoint").value = controlData.setpoints.co2;

                // Need to still add light schedule (might cause issues)
            }
        }

        function updateUIWithSensorData() {
            if (CO2Data && tempData && humidData) {
                // Update your UI elements with the fetched data
                //document.getElementById('timelapse-status').textContent = tlData.status;
                document.getElementById('co2-ppm').innerText = CO2Data.co2 + " ppm";
                document.getElementById('ds-temp1').innerText = "Ouside|" + tempData.Probe1 + " °C";
                document.getElementById('ds-temp2').innerText = "Coil|" + tempData.Probe2 + " °C";
                document.getElementById('ds-temp3').innerText = "Peltier|" + tempData.Probe3 + " °C";
                document.getElementById('dht-humidity').innerText = humidData.humidity + " %";

            }
        }

        setInterval(get_env_parameters, 8000);
        //setInterval(updateUIWithSensorData, 5000);

        get_env_parameters();
        //updateUIWithSensorData();

        //setInterval(get_control_parameters, 8000);
        //setInterval(updateUIWithControlData, 5000);

        get_control_parameters();
        //updateUIWithControlData();
        


        document.addEventListener('DOMContentLoaded', function() {
            // Wait for data to load before setting up event listeners
            setTimeout(() => {
                // Add event listeners to all parameter inputs
                const parameterInputs = document.querySelectorAll('.parameter-input');
                parameterInputs.forEach(input => {
                    input.addEventListener('input', handleInputChange);
                });

                // Add event listener to save button
                const saveButton = document.getElementById('save-button');
                if (saveButton) {
                    saveButton.addEventListener('click', saveChanges);
                }
                
                // Disable buttons for non-admin users
                {% if not current_user.is_admin %}
                const adminButtons = document.querySelectorAll('button');
                adminButtons.forEach(button => {
                    if (button.onclick && button.onclick.toString().includes('fetch')) {
                        button.disabled = true;
                        button.classList.add('admin-only');
                        button.title = "Admin access required";
                    }
                });
                {% endif %}
            }, 1000); // Wait 1 second for initial data to load
        });

        function handleInputChange(event) {
            const input = event.target;
            const inputId = input.id;
            
            // Check if value has changed from original
            if (input.value != originalValues[inputId]) {
                input.classList.add('unsaved');
                changedInputs.add(inputId);
            } else {
                input.classList.remove('unsaved');
                changedInputs.delete(inputId);
            }
            
            // Enable/disable save button based on whether there are changes
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = changedInputs.size === 0;
            
            // Show/hide unsaved changes message
            const unsavedMessage = document.getElementById('unsaved-message');
            unsavedMessage.style.display = changedInputs.size > 0 ? 'block' : 'none';
        }

        async function saveChanges() {
            
            // Just update the original values
            changedInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                originalValues[inputId] = input.value;
                
                // Remove unsaved styling
                input.classList.remove('unsaved');
            });
            
            // Clear changed inputs
            changedInputs.clear();
            
            // Disable save button
            document.getElementById('save-button').disabled = true;
            
            // Hide unsaved message, show saved message
            document.getElementById('unsaved-message').style.display = 'none';
            const savedMessage = document.getElementById('saved-message');
            savedMessage.style.display = 'block';
            
            // Hide saved message after 4 seconds
            setTimeout(() => {
                savedMessage.style.display = 'none';
            }, 4000);
            

            try {
                if (originalValues['timelapse-interval']) {
                    await setTimelapseInterval(originalValues['timelapse-interval']);
                }

                // if (originalValues['temperature-setpoint']) {
                //     await setTemperature(originalValues['temperature-setpoint']);
                // }

                await setSetpoints(originalValues);
                
                console.log("All changes saved successfully");
                
            } catch (error) {
                // Handle any errors that occurred during saving
                console.error("Error saving changes:", error);
                
                // You might want to revert the UI changes or show an error message
                showErrorNotification("Failed to save some changes");
            }
        }

        function showErrorNotification(message) {
            console.error(message);
            alert(message); // temporary visible feedback
        }


        // Check for external updates every 10 seconds
        // setInterval(checkForExternalUpdates, 10000);
        
        // async function fetchClip() {
        //     document.getElementById('camera-status').innerText = "Recording clip...";
        //     const res = await fetch('/take_clip');
        //     const text = await res.text();
        //     document.getElementById('camera-status').innerText = text;
        // }
        //Test stuff______________________________________



        // async function setSetpoints(originalValues) {
        //     // Extract values from originalValues
        //     let temperature = Number(originalValues['temperature-setpoint']);
        //     let humidity = Number(originalValues['humidity-setpoint']);
        //     let co2_max = Number(originalValues['co2-setpoint']);
        //     let light_schedules = originalValues['light-schedule'] ?? [ 
        //         { start: "08:00", end: "18:00", white: 0.5,uv: 0.5 },
        //         { start: "01:00", end: "04:00", white: 0.5,uv: 0.5 }
        //     ];      // Default might cause issues later

        //     // --- Error checks ---
        //     const errors = [];
        //     if (!isNaN(temperature)) {
        //         if (temperature <= 5 || temperature >= 40) {
        //             errors.push("Temperature must be between 5-40 °C.");
        //         }
        //     } else {
        //         temperature = undefined; // don't send if invalid
        //     }

        //     if (!isNaN(humidity)) {
        //         if (humidity < 0 || humidity > 100) {
        //             errors.push("Humidity must be between 0-100%.");
        //         }
        //     } else {
        //         humidity = undefined;
        //     }

        //     if (!isNaN(co2_max)) { // Changed to co2_max
        //         if (co2_max <= 0 || co2_max > 5000) {
        //             errors.push("CO2 must be >0 and <=5000 ppm.");
        //         }
        //     } else {
        //         co2_max = undefined; // Changed to co2_max
        //     }

        //     if (errors.length > 0) {
        //         const errorMsg = errors.join(" ");
        //         console.error("Setpoints validation errors:", errorMsg);
        //         showErrorNotification(errorMsg);
        //         throw new Error(errorMsg);
        //     }

        //     // --- Build JSON payload ---
        //     const payload = {};
        //     if (temperature !== undefined) payload.temperature = temperature;
        //     if (humidity !== undefined) payload.humidity = humidity;
        //     if (co2_max !== undefined) payload.co2_max = co2_max; // Changed to co2_max
        //     if (light_schedules !== undefined) payload.light_schedules = light_schedules; // Changed to light_schedules

        //     console.log("Sending payload:", payload); // Debug log

        //     // --- Send to server ---
        //     try {
        //         const response = await fetch('/update_setpoints', { // Changed route name
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify(payload)
        //         });

        //         if (!response.ok) {
        //             const errorText = await response.text();
        //             throw new Error(`Server returned ${response.status}: ${errorText}`);
        //         }

        //         const result = await response.json();
        //         console.log("Setpoints updated successfully:", result);
        //         return result;

        //     } catch (error) {
        //         console.error("Failed to set setpoints:", error);
        //         showErrorNotification(`Failed to update setpoints: ${error.message}`);
        //         throw error;
        //     }
        // }



        async function setSetpoints(originalValues) {
            // Extract values from originalValues - ONLY the ones you have UI for
            let temperature = Number(originalValues['temperature-setpoint']);
            let humidity = Number(originalValues['humidity-setpoint']);
            let co2_max = Number(originalValues['co2-setpoint']);
            
            // Remove light schedules for now until you implement the UI
            // let light_schedules = originalValues['light-schedule'];

            // --- Error checks (same as before) ---
            const errors = [];
            if (!isNaN(temperature)) {
                if (temperature <= 5 || temperature >= 40) {
                    errors.push("Temperature must be between 5-40 �C.");
                }
            } else {
                temperature = undefined;
            }

            if (!isNaN(humidity)) {
                if (humidity < 0 || humidity > 100) {
                    errors.push("Humidity must be between 0-100%.");
                }
            } else {
                humidity = undefined;
            }

            if (!isNaN(co2_max)) {
                if (co2_max <= 0 || co2_max > 5000) {
                    errors.push("CO2 must be >0 and <=5000 ppm.");
                }
            } else {
                co2_max = undefined;
            }

            if (errors.length > 0) {
                const errorMsg = errors.join(" ");
                console.error("Setpoints validation errors:", errorMsg);
                showErrorNotification(errorMsg);
                throw new Error(errorMsg);
            }

            // --- Build JSON payload - ONLY include what you have ---
            const payload = {};
            if (temperature !== undefined) payload.temperature = temperature;
            if (humidity !== undefined) payload.humidity = humidity;
            if (co2_max !== undefined) payload.co2_max = co2_max;
            // Don't include light_schedules until you have the UI

            console.log("Sending payload:", JSON.stringify(payload, null, 2));

            // --- Send to server ---
            try {
                const response = await fetch('/update_setpoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Server error: ${errorData.message || response.statusText}`);
                }

                const result = await response.json();
                console.log("Setpoints updated successfully:", result);
                return result;

            } catch (error) {
                console.error("Failed to set setpoints:", error);
                showErrorNotification(`Failed to update setpoints: ${error.message}`);
                throw error;
            }
        }














        // async function setTemperature(temperatureSetpoint) {
        //     temperatureSetpoint = Number(temperatureSetpoint); // ensure it's numeric

        //     if ((isNaN(temperatureSetpoint) || temperatureSetpoint <= 5 || temperatureSetpoint >= 40))  {
        //         throw new Error("Invalid temperature value value. Must be a within 5-40°C.");
        //     }

        //     try {
        //         const response = await fetch(`/set_temp/${temperatureSetpoint}`, {method: 'POST'});

        //         if (!response.ok) {
        //             throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        //         }

        //         const result = await response.json();
        //         console.log("Temperature set successfully:", result);
        //         return result;

        //     } catch (error) {
        //         console.error("Failed to set temperature:", error);
        //         showErrorNotification(`Failed to set temperature: ${error.message}`);
        //         throw error;
        //     }
        // }


        //-_________________________________________



        async function setTimelapseInterval(intervalValue) {
            intervalValue = Number(intervalValue); // ensure it's numeric

            if (isNaN(intervalValue) || intervalValue <= 0) {
                throw new Error("Invalid interval value. Must be a positive number.");
            }

            try {
                const response = await fetch(`/set_tl_rate/${intervalValue}`, {method: 'POST'});

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log("Timelapse interval set successfully:", result);
                return result;

            } catch (error) {
                console.error("Failed to set timelapse interval:", error);
                showErrorNotification(`Failed to set interval: ${error.message}`);
                throw error;
            }
        }


        async function updateImage() {
            const img = document.getElementById('webcam');
            img.src = '/send_latest_image?t=' + new Date().getTime();  // bust cache

            document.getElementById('photo-status').innerText = "Photo updated according to time stamp"; 
        }
        

        async function refreshManual() {
            document.getElementById('photo-status').innerText = "Capturing photo...";
            try {
                const res = await fetch('/take_photo');
                const data = await res.json();
                if (data.success) {updateImage()}
            } catch (err) {console.error("Error taking image:", err);}
        }
        
    
        async function updateTimelapseStatus() {
            try {
                // Safe access using optional chaining
                const statusText = tlData?.status ?? "Unknown";
                const isRunning = tlData?.status?.toLowerCase().includes("running") ?? false;
                const statusColor = isRunning ? "darkgreen" : "orange";

                document.getElementById("tl-status").innerHTML = `
                    <div>
                    Timelapse status: 
                    <span style="font-weight:bold; color:${statusColor};">${statusText}</span><br>
                    Started: ${tlData?.start_timestamp ?? "N/A"}<br>
                    Number of photos: ${tlData?.iterations ?? "N/A"}<br>
                    Current: ${tlData?.last_timestamp ?? "N/A"}
                    </div>
                `;

            } catch (err) {
                console.error(err);
                document.getElementById("tl-status").innerText =
                "Error loading timelapse status";
            }
        }

                

        async function toggleTimelapse() {
            try {
                const res = await fetch('/toggle_tl');
                get_control_parameters();
                // updateTimelapseStatus();
            } catch (err) {
                console.error("Error toggling timelapse:", err);
            }
        }

        // Optionally refresh every few seconds
        setInterval(updateTimelapseStatus, 5000);
        setInterval(updateImage, 6000);
        
        updateTimelapseStatus();
    </script>
{% endblock %}